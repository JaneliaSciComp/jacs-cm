version: "3.7"

services:

  jacs-async:
    image: ${NAMESPACE}/jacs-async:${JACS_ASYNC_COMPUTE_VERSION}
    user: "0:${DOCKER_GID}"
    volumes:
      - ${CONFIG_DIR}/jacs-async:/app/config:ro
      - ${DATA_DIR}:/data
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - SERVICE_MODE=async
      - HOSTNAME=jacs-async
      - JACS2_CONFIG=/app/config/jacs.properties
      - JACS2_ASYNCWEB_OPTS=-Dlogback.configurationFile=/app/config/logback.xml
      - jacs_JWT_SecretKey=${JWT_SECRET_KEY}
      - jacs_MongoDB_ServerName=${MONGODB_SERVER}
      - jacs_MongoDB_AuthDatabase=${MONGODB_INIT_DATABASE}
      - jacs_MongoDB_Username=${MONGODB_APP_USERNAME}
      - jacs_MongoDB_Password=${MONGODB_APP_PASSWORD}
      - jacs_Solr_ServerURL=http://solr:8080/solr/
      - jacs_Messaging_Server=rabbitmq
      - jacs_Messaging_User=${RABBITMQ_USER}
      - jacs_Messaging_Password=${RABBITMQ_PASSWORD}
      - jacs_StorageService_URL=http://jade-master:8080/jacsstorage/master_api/v1
      - jacs_StorageService_ApiKey=${JADE_API_KEY}
      - jacs_JACS_ApiKey=${JACS_API_KEY}
      - jacs_service_queue_id=${JACS_QUEUE_ID}
    expose:
      - "8080"
    ports:
      - "9000:8080"
    restart: unless-stopped
    networks:
      - jacs-net

  jade-agent1:
    volumes:
      - /groups/scicompsys/reports:/groups/scicompsys/reports:ro,shared
      - /nrs/jacs/jacsData:/nrs/jacs/jacsData:ro,shared
      - /groups/jacs/jacsDev:/groups/jacs/jacsDev:shared
      - /groups/flylight:/groups/flylight:ro,shared
      - /groups/projtechres:/groups/projtechres:ro,shared
      - /groups/ditp:/groups/ditp:ro,shared
      - /groups/leet:/groups/leet:ro,shared
      - /groups/lightsheet:/groups/lightsheet:ro,shared
      - /groups/scicomp/lsms:/groups/scicomp/lsms:ro,shared
      - /groups/mousebrainmicro:/groups/mousebrainmicro:ro,shared
      - /nrs/mouselight:/nrs/mouselight:ro,shared
      - /nrs/svoboda:/nrs/svoboda:ro,shared
      - /data/s3:/data/s3:shared
      - /nearline/flylight:/nearline/flylight:shared
      - /nearline/jacs:/nearline/jacs:shared
      - /groups/cellmap:/groups/cellmap:shared
      - /nrs/scicompsoft:/nrs/scicompsoft:shared
      - /nrs/cellmap:/nrs/cellmap:shared
      - /nrs/lsms:/nrs/lsms:ro,shared
